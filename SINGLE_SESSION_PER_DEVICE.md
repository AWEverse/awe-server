# Реализация одной сессии на устройство

## Обзор
Реализована логика обеспечения только одной активной сессии на устройство для повышения безопасности и управления ресурсами.

## Изменения в AuthService

### 1. Новый helper метод `deactivateOldDeviceSessions`
```typescript
private async deactivateOldDeviceSessions(
  userId: bigint,
  deviceId: number,
  transaction?: any,
): Promise<{ deactivatedSessions: number; revokedTokens: number }>
```

**Функции:**
- Деактивирует все существующие сессии для указанного устройства
- Отзывает все связанные refresh токены
- Логирует количество деактивированных сессий и отозванных токенов

### 2. Обновленные методы login() и register()
- При создании новой сессии сначала деактивируются все старые сессии для того же устройства
- Обеспечивается атомарность операций через транзакции
- Применяется как для локальных JWT токенов, так и для Supabase токенов

### 3. Новые вспомогательные методы
- `getActiveDeviceSession(userId, deviceId)` - получение активной сессии устройства
- `hasActiveDeviceSession(userId, deviceId)` - проверка наличия активной сессии

## Преимущества безопасности

### 1. Предотвращение захвата сессий
- Невозможность использования украденных токенов, если пользователь перелогинился
- Автоматическая инвалидация старых сессий при новом входе

### 2. Управление ресурсами
- Предотвращение накопления неактивных сессий в БД
- Снижение нагрузки на систему от множественных токенов

### 3. Улучшенный аудит
- Четкая связь между устройством и сессией
- Логирование всех операций деактивации сессий

## Поведение системы

### При входе (login):
1. Проверяется наличие активных сессий для устройства
2. Все найденные сессии деактивируются (flags = 0)
3. Все связанные refresh токены отзываются (isRevoked = true)
4. Создается новая сессия с новым refresh токеном

### При регистрации (register):
1. Аналогичная логика применяется на случай повторной регистрации с того же устройства
2. Обеспечивается чистота данных с самого начала

### При обновлении токена (refresh):
- Логика остается прежней, так как используется существующая сессия
- Дополнительные проверки безопасности сохраняются

## Техническая реализация

### Транзакционность
Все операции выполняются в рамках Prisma транзакций для обеспечения консистентности данных.

### Обработка ошибок
- Деактивация сессий не блокирует создание новой сессии
- Логирование всех критических операций
- Graceful handling при недоступности БД

### Совместимость
- Сохранена совместимость с существующим API
- Работает как с Supabase, так и с локальными JWT токенами
- Не нарушает существующую логику refresh токенов

## Мониторинг и метрики

Рекомендуется добавить мониторинг следующих метрик:
- Количество деактивированных сессий в день
- Средний lifetime сессий
- Случаи множественных одновременных логинов с одного устройства

## Будущие улучшения

1. **Уведомления пользователей** о деактивации сессий на других устройствах
2. **Настраиваемая политика** - позволить несколько сессий для определенных типов устройств
3. **Геолокационные проверки** при создании новых сессий
4. **Более детальный аудит** с записью причин деактивации сессий
