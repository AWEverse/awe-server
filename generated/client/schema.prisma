// –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –º—É–ª—å—Ç–∏–º–µ–¥–∏–π–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
// –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä, –≤–∏–¥–µ–æ—Ö–æ—Å—Ç–∏–Ω–≥, —Å–æ—Ü–∏–∞–ª—å–Ω—É—é —Å–µ—Ç—å –∏ —Ñ–æ—Ä—É–º
// 
// –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:
// 1. BigInt ID –≤–º–µ—Å—Ç–æ UUID (—ç–∫–æ–Ω–æ–º–∏—è 75% –º–µ—Å—Ç–∞ –≤ –∏–Ω–¥–µ–∫—Å–∞—Ö –∏ FK)
// 2. –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ Boolean –ø–æ–ª–µ–π  
// 3. –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ VARCHAR —Å —Ç–æ—á–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
// 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
// 5. Timestamptz(3) –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (—ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞)
// 6. –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
// 7. JSON –¥–ª—è –≥–∏–±–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫
// 8. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
// 9. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
// 10. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è foreign key constraints –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
  output          = "../generated/client"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pg_trgm, btree_gin, btree_gist]
}

// ===== ENUMS =====

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
  DELETED
  RESTRICTED
}

enum ChatType {
  PRIVATE
  GROUP
  CHANNEL
  COMMUNITY
}

enum ChatRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
  SUBSCRIBER
}

enum MessageType {
  SYSTEM
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  DOCUMENT
  STICKER
  VOICE
  VIDEO_NOTE
  LOCATION
  CONTACT
  POLL
  DICE
  GAME
  EMOJI
  GIF
  MARKDOWN
  CUSTOM_EMOJI
  STICKER_PACK
}

enum ContentType {
  VIDEO
  SHORT_VIDEO
  LIVE_STREAM
  PODCAST
  IMAGE_POST
  TEXT_POST
  STORY
  THREAD
  FORUM_POST
  FORUM_REPLY
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  UNLISTED
  PRIVATE
  SCHEDULED
  ARCHIVED
  DELETED
  UNDER_REVIEW
}

enum SubscriptionType {
  FREE
  PREMIUM
  CREATOR
  BUSINESS
}

enum NotificationType {
  MESSAGE
  REACTION
  COMMENT
  LIKE
  FOLLOW
  MENTION
  VIDEO_UPLOAD
  LIVE_START
  COMMUNITY_POST
}

enum ReportReason {
  SPAM
  HARASSMENT
  HATE_SPEECH
  VIOLENCE
  COPYRIGHT
  ADULT_CONTENT
  MISINFORMATION
  SCAM
  FAKE_ACCOUNT
  IMPERSONATION
  TERRORISM
  SELF_HARM
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
  ESCALATED
}

enum ModerationAction {
  NONE
  MOVE

  WARN
  PIN
  UNPIN
  FEATURE
  UNFEATURE
  LOCK
  UNLOCK
  TIMEOUT
  DELETE
  SUSPEND_USER
  BAN_USER
  SHADOWBAN
}

enum ChatPermission {
  SEND_MESSAGES
  SEND_MEDIA
  ADD_MEMBERS
  REMOVE_MEMBERS
  EDIT_INFO
  PIN_MESSAGES
  DELETE_MESSAGES
  BAN_MEMBERS
  MANAGE_PERMISSIONS
}

// ===== –û–°–ù–û–í–ù–´–ï –ú–û–î–ï–õ–ò =====

model RoleGlobally {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(32)
  flags       Int      @default(0) // founder(1), admin(2), moderator(4), verified(8)
  permissions Json?
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)

  users            User[]
  forumPermissions ForumCategoryPermission[]

  @@index([name])
  @@index([flags])
}

model User {
  id          BigInt  @id @default(autoincrement())
  email       String  @unique @db.VarChar(320) // RFC 5321 compliant
  username    String  @unique @db.VarChar(32)
  password    String  @db.VarChar(128) // –•—ç—à –ø–∞—Ä–æ–ª—è
  supabaseId  String? @unique @db.VarChar(36) // Supabase UUID
  fullName    String? @db.VarChar(128)
  bio         String? @db.VarChar(500)
  avatarUrl   String? @db.VarChar(512)
  bannerUrl   String? @db.VarChar(512)
  color       String? @db.Char(7) // HEX —Ü–≤–µ—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
  phoneNumber String? @unique @db.VarChar(15)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: verified(1), bot(2), online(4), creator(8), live(16), premium(32), staff(64)
  // –í–ê–ñ–ù–û: –ú–∞–∫—Å–∏–º—É–º 31 —Ñ–ª–∞–≥ –¥–ª—è Int (2^31-1)
  flags  Int        @default(0)
  status UserStatus @default(ACTIVE)

  lastSeen  DateTime? @db.Timestamptz(3)
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)
  roleId    BigInt? // Nullable, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ—Å—Ç–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

  // –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (PostgreSQL tsvector –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
  searchVector Unsupported("tsvector")?
  timezone     String?                  @db.VarChar(32)
  locale       String?                  @db.VarChar(10) // –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è locale —Ç–∏–ø–∞ en-US

  // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏)
  subscribersCount   Int    @default(0)
  subscriptionsCount Int    @default(0)
  videosCount        Int    @default(0)
  postsCount         Int    @default(0)
  totalViews         BigInt @default(0)
  totalLikes         BigInt @default(0)
  reputation         Int    @default(0) // –î–ª—è —Ñ–æ—Ä—É–º–∞

  // –°–≤—è–∑–∏
  role                   RoleGlobally?           @relation(fields: [roleId], references: [id])
  devices                Device[]
  sessions               Session[]
  chatsCreated           Chat[]                  @relation("chatsCreated")
  chatParticipants       ChatParticipant[]
  messages               Message[]               @relation("messagesSent")
  refreshTokens          RefreshToken[]
  refreshTokensBlacklist RefreshTokenBlacklist[]
  userCrypto             UserCrypto?
  messageReactions       MessageReaction[]
  messageReads           MessageRead[]
  contactsAdded          ContactList[]           @relation("UserContacts")
  contactOf              ContactList[]           @relation("ContactOf")
  userSettings           UserSettings?
  notificationSettings   NotificationSettings[]

  // –ö–æ–Ω—Ç–µ–Ω—Ç –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  contents        Content[]
  comments        Comment[]
  likes           Like[]
  subscriptions   Subscription[] @relation("UserSubscriptions")
  subscribers     Subscription[] @relation("SubscribedTo")
  playlists       Playlist[]
  watchHistory    WatchHistory[]
  notifications   Notification[]
  reports         Report[]       @relation("ReportedBy")
  reportedContent Report[]       @relation("ReportedUser")
  reviewedReports Report[]       @relation("ReviewedReports")

  // –§–æ—Ä—É–º
  ownedForums             Forum[]             @relation("ForumOwner")
  forumModeratorRoles     ForumModerator[]    @relation("ForumModeratorRoles")
  assignedForumModerators ForumModerator[]    @relation("AssignedForumModerators")
  forumPosts              ForumPost[]
  forumReplies            ForumReply[]
  forumSubscriptions      ForumSubscription[]
  forumVotes              ForumVote[]

  // –ú–æ–¥–µ—Ä–∞—Ü–∏—è
  moderatorActions ForumModerationLog[] @relation("ModeratorActions")
  moderatedActions ForumModerationLog[] @relation("ModeratedUsers")

  // –§–æ—Ä—É–º - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
  categoryModerators ForumCategoryModerator[] @relation("CategoryModerators")
  assignedModerators ForumCategoryModerator[] @relation("AssignedModerators")
  forumTrackers      ForumTopicTracker[]      @relation("ForumTrackers")
  forumReputation    ForumReputation?         @relation("UserReputation")
  forumNotifications ForumNotificationQueue[] @relation("ForumNotifications")

  // Stickers, Emojis –∏ Media
  createdStickerPacks StickerPack[]     @relation("CreatedStickerPacks")
  stickerPurchases    StickerPurchase[]
  userStickerPacks    UserStickerPack[]
  createdEmojis       CustomEmoji[]     @relation("CreatedEmojis")
  chatFolders         ChatFolder[]      @relation("UserFolders")

  // Security
  securityAudits      SecurityAuditLog[] @relation("SecurityAudits")
  securityResolutions SecurityAuditLog[] @relation("SecurityResolver")

  @@index([email])
  @@index([username])
  @@index([phoneNumber])
  @@index([roleId])
  @@index([status, flags])
  @@index([lastSeen])
  @@index([createdAt])
  @@index([status, deletedAt])
  @@index([subscribersCount])
  @@index([totalViews])
  @@index([reputation]) // –î–ª—è —Ñ–æ—Ä—É–º–∞
  @@index([flags, status]) // –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  @@index([createdAt, flags]) // –î–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
}

model Device {
  id            BigInt    @id @default(autoincrement())
  userId        BigInt
  deviceId      String    @unique
  deviceName    String?   @db.VarChar(64)
  deviceType    String?   @db.VarChar(32)
  deviceVersion String?   @db.VarChar(32)
  ipAddress     String?   @db.Inet
  userAgent     String?   @db.VarChar(512) // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö UA
  fingerprint   String?   @db.VarChar(256) // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  flags         Int       @default(1) // isActive(1), trusted(2)
  lastUsed      DateTime? @db.Timestamptz(3)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@index([userId])
  @@index([deviceId])
  @@index([userId, flags]) // –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–π
  @@index([lastUsed])
}

model Session {
  id           BigInt    @id @default(autoincrement())
  userId       BigInt    @unique
  deviceId     BigInt    @unique
  ratchetState Bytes
  sessionKey   String?   @db.VarChar(256)
  expiresAt    DateTime? @db.Timestamptz(3)
  createdAt    DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(3)
  flags        Int       @default(1) // isActive(1)

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  device       Device         @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  RefreshToken RefreshToken[]

  @@index([userId])
  @@index([deviceId])
  @@index([userId, flags])
  @@index([expiresAt])
  @@index([sessionKey])
}

model UserCrypto {
  id                BigInt   @id @default(autoincrement())
  userId            BigInt   @unique
  identityKeyPublic String   @db.VarChar(128)
  createdAt         DateTime @default(now()) @db.Timestamptz(3)
  updatedAt         DateTime @updatedAt @db.Timestamptz(3)

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  signedPreKeys      SignedPreKey[]
  oneTimePreKeys     OneTimePreKey[]
  usedOneTimePreKeys UsedOneTimePreKey[]

  @@index([userId])
}

model SignedPreKey {
  id           BigInt    @id @default(autoincrement())
  userCryptoId BigInt
  keyId        Int
  publicKey    String    @db.VarChar(128)
  signature    String    @db.VarChar(128)
  createdAt    DateTime  @default(now()) @db.Timestamptz(3)
  flags        Int       @default(0) // isUsed(1)
  expiresAt    DateTime? @db.Timestamptz(3)

  userCrypto UserCrypto @relation(fields: [userCryptoId], references: [id], onDelete: Cascade)

  @@unique([userCryptoId, keyId])
  @@index([userCryptoId])
  @@index([flags])
  @@index([expiresAt])
}

model OneTimePreKey {
  id           BigInt   @id @default(autoincrement())
  userCryptoId BigInt
  keyId        Int
  publicKey    String   @db.VarChar(128)
  createdAt    DateTime @default(now()) @db.Timestamptz(3)
  flags        Int      @default(0) // isUsed(1)

  userCrypto UserCrypto @relation(fields: [userCryptoId], references: [id], onDelete: Cascade)

  @@unique([userCryptoId, keyId])
  @@index([userCryptoId])
  @@index([flags])
  @@index([createdAt])
}

model UsedOneTimePreKey {
  id           BigInt   @id @default(autoincrement())
  userCryptoId BigInt
  keyId        Int
  usedAt       DateTime @default(now()) @db.Timestamptz(3)

  userCrypto UserCrypto @relation(fields: [userCryptoId], references: [id], onDelete: Cascade)

  @@unique([userCryptoId, keyId])
  @@index([userCryptoId])
  @@index([usedAt])
}

// ===== SECURITY AUDIT =====

model SecurityAuditLog {
  id          BigInt    @id @default(autoincrement())
  userId      BigInt?
  eventType   String    @db.VarChar(50)
  severity    String    @db.VarChar(20) // LOW, MEDIUM, HIGH, CRITICAL
  description String    @db.VarChar(500)
  ipAddress   String?   @db.Inet
  userAgent   String?   @db.VarChar(512)
  metadata    Json?
  timestamp   DateTime  @default(now()) @db.Timestamptz(3)
  resolvedAt  DateTime? @db.Timestamptz(3)
  resolvedBy  BigInt?

  // Relations
  user     User? @relation("SecurityAudits", fields: [userId], references: [id], onDelete: SetNull)
  resolver User? @relation("SecurityResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@index([ipAddress])
  @@index([userId, timestamp])
  @@index([eventType, timestamp])
  @@index([severity, timestamp])
}

// ===== –ú–ï–°–°–ï–ù–î–ñ–ï–† =====

model Chat {
  id          BigInt   @id @default(autoincrement())
  type        ChatType
  createdById BigInt
  title       String?  @db.VarChar(128)
  description String?  @db.VarChar(500)
  avatarUrl   String?  @db.VarChar(200)
  bannerUrl   String?  @db.VarChar(200)
  color       String?  @db.Char(7) // HEX —Ü–≤–µ—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: archived(1), public(2), verified(4), premium(8)
  flags Int @default(0)

  inviteLink      String?   @unique @db.VarChar(64)
  memberCount     Int       @default(0)
  lastMessageAt   DateTime? @db.Timestamptz(3)
  lastMessageText String?   @db.VarChar(100) // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–µ–≤—å—é
  createdAt       DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt       DateTime? @db.Timestamptz(3)

  createdBy            User                   @relation("chatsCreated", fields: [createdById], references: [id])
  participants         ChatParticipant[]
  messages             Message[]
  pinnedMessageId      BigInt?
  pinnedMessage        Message?               @relation("PinnedMessage", fields: [pinnedMessageId], references: [id])
  chatSettings         ChatSettings?
  notificationSettings NotificationSettings[]
  customEmojis         CustomEmoji[]          @relation("CustomEmojis")
  folderItems          ChatFolderItem[]       @relation("FolderItems")

  @@index([type])
  @@index([createdById])
  @@index([flags])
  @@index([lastMessageAt])
  @@index([memberCount])
  @@index([type, flags])
  @@index([createdAt])
  @@index([deletedAt])
}

model ChatParticipant {
  id       BigInt    @id @default(autoincrement())
  chatId   BigInt
  userId   BigInt
  role     ChatRole  @default(MEMBER)
  joinedAt DateTime  @default(now()) @db.Timestamptz(3)
  leftAt   DateTime? @db.Timestamptz(3)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: admin(1), owner(2), muted(4), banned(8)
  flags      Int       @default(0)
  mutedUntil DateTime? @db.Timestamptz(3)

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([chatId])
  @@index([userId])
  @@index([role])
  @@index([joinedAt])
  @@index([leftAt])
  @@index([chatId, role])
  @@index([userId, leftAt])
}

model Message {
  id          BigInt      @id @default(autoincrement())
  chatId      BigInt
  senderId    BigInt
  content     Bytes // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
  header      Bytes // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  messageType MessageType @default(TEXT)
  createdAt   DateTime    @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(3)
  editedAt    DateTime?   @db.Timestamptz(3)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: deleted(1), edited(2), forwarded(4), pinned(8)
  flags     Int       @default(0)
  deletedAt DateTime? @db.Timestamptz(3)

  replyToId       BigInt?
  forwardedFromId BigInt?
  threadId        BigInt? // –î–ª—è —Ç—Ä–µ–¥–æ–≤ –≤ —á–∞—Ç–∞—Ö
  replyDepth      Int     @default(0) // –ì–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤ (–º–∞–∫—Å 10)

  chat            Chat                @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender          User                @relation("messagesSent", fields: [senderId], references: [id])
  replyTo         Message?            @relation("ReplyTo", fields: [replyToId], references: [id])
  replies         Message[]           @relation("ReplyTo")
  forwardedFrom   Message?            @relation("ForwardedFrom", fields: [forwardedFromId], references: [id])
  forwards        Message[]           @relation("ForwardedFrom")
  thread          MessageThread?      @relation("ThreadMessage", fields: [threadId], references: [id])
  attachments     MessageAttachment[]
  reactions       MessageReaction[]
  edits           MessageEdit[]
  pinnedIn        Chat[]              @relation("PinnedMessage")
  messageReads    MessageRead[]
  messageStickers MessageSticker[]
  messageEmojis   MessageEmoji[]
  messageGifs     MessageGif[]

  @@index([chatId, createdAt])
  @@index([senderId])
  @@index([messageType])
  @@index([flags])
  @@index([replyToId])
  @@index([forwardedFromId])
  @@index([threadId])
  @@index([replyDepth]) // –î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≥–ª—É–±–∏–Ω—ã
  @@index([chatId, flags, createdAt])
  @@index([deletedAt])
}

model MessageThread {
  id        BigInt   @id @default(autoincrement())
  chatId    BigInt
  creatorId BigInt
  title     String?  @db.VarChar(128)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)
  flags     Int      @default(0) // active(1), locked(2)

  messages Message[] @relation("ThreadMessage")

  @@index([chatId])
  @@index([creatorId])
  @@index([createdAt])
}

model MessageEdit {
  id        BigInt   @id @default(autoincrement())
  messageId BigInt
  content   Bytes
  editedAt  DateTime @default(now()) @db.Timestamptz(3)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([editedAt])
}

model MessageAttachment {
  id          BigInt   @id @default(autoincrement())
  messageId   BigInt
  fileName    String   @db.VarChar(128)
  mimeType    String   @db.VarChar(64)
  fileHash    String   @db.VarChar(64)
  fileKey     String   @db.VarChar(64)
  fileIV      String   @db.VarChar(32)
  fileSize    Int
  fileType    String   @db.VarChar(16)
  thumbnail   String?  @db.VarChar(200)
  description String?  @db.VarChar(255)
  url         String   @db.VarChar(512)
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([mimeType])
  @@index([fileType])
  @@index([fileHash])
}

model MessageReaction {
  id        BigInt   @id @default(autoincrement())
  messageId BigInt
  userId    BigInt
  reaction  String   @db.VarChar(32) // –ù–∞–ø—Ä–∏–º–µ—Ä, "üëç", "‚ù§Ô∏è", "üòÇ" 
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, reaction])
  @@index([messageId])
  @@index([userId])
  @@index([reaction])
}

model MessageRead {
  id        BigInt    @id @default(autoincrement())
  messageId BigInt
  userId    BigInt
  readAt    DateTime? @db.Timestamptz(3)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@index([readAt])
  @@index([userId, readAt])
}

// ===== –°–¢–ò–ö–ï–†–´, –≠–ú–û–î–ñ–ò –ò –ú–ï–î–ò–ê =====

model StickerPack {
  id           BigInt  @id @default(autoincrement())
  name         String  @db.VarChar(64)
  title        String  @db.VarChar(128)
  description  String? @db.VarChar(255)
  authorId     BigInt?
  thumbnailUrl String  @db.VarChar(512)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: premium(1), animated(2), official(4), nsfw(8), disabled(16)
  flags    Int     @default(0)
  price    Int     @default(0) // –í —Ü–µ–Ω—Ç–∞—Ö, 0 = –±–µ—Å–ø–ª–∞—Ç–Ω–æ
  category String? @db.VarChar(32)
  tags     String? @db.VarChar(255) // –¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

  downloadCount Int @default(0)
  usageCount    Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  author    User?             @relation("CreatedStickerPacks", fields: [authorId], references: [id])
  stickers  Sticker[]
  purchases StickerPurchase[]
  userPacks UserStickerPack[]

  @@index([authorId])
  @@index([flags])
  @@index([category])
  @@index([downloadCount])
  @@index([usageCount])
  @@index([createdAt])
}

model Sticker {
  id       BigInt @id @default(autoincrement())
  packId   BigInt
  emoji    String @db.VarChar(32) // –ê—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–º–æ–¥–∂–∏
  fileUrl  String @db.VarChar(512)
  fileName String @db.VarChar(128)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  width    Int
  height   Int
  fileSize Int
  mimeType String @db.VarChar(32)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: animated(1), premium(2)
  flags Int @default(0)

  usageCount Int @default(0)
  position   Int @default(0) // –ü–æ–∑–∏—Ü–∏—è –≤ –ø–∞–∫–µ

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  pack     StickerPack      @relation(fields: [packId], references: [id], onDelete: Cascade)
  messages MessageSticker[]

  @@index([packId])
  @@index([emoji])
  @@index([usageCount])
  @@index([position])
}

model CustomEmoji {
  id       BigInt  @id @default(autoincrement())
  chatId   BigInt? // –ï—Å–ª–∏ null - –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–º–æ–¥–∂–∏
  authorId BigInt
  name     String  @db.VarChar(32) // :custom_name:
  fileUrl  String  @db.VarChar(512)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  width    Int
  height   Int
  fileSize Int
  mimeType String @db.VarChar(32)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: animated(1), premium(2), verified(4), disabled(8)
  flags Int @default(0)

  usageCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  chat     Chat?          @relation("CustomEmojis", fields: [chatId], references: [id], onDelete: Cascade)
  author   User           @relation("CreatedEmojis", fields: [authorId], references: [id])
  messages MessageEmoji[]

  @@unique([chatId, name])
  @@index([chatId])
  @@index([authorId])
  @@index([name])
  @@index([flags])
  @@index([usageCount])
}

model GifCategory {
  id          BigInt  @id @default(autoincrement())
  name        String  @unique @db.VarChar(64)
  description String? @db.VarChar(255)
  iconUrl     String? @db.VarChar(512)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: trending(1), featured(2), nsfw(4)
  flags    Int @default(0)
  position Int @default(0)

  gifCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  gifs Gif[]

  @@index([name])
  @@index([flags])
  @@index([position])
}

model Gif {
  id         BigInt @id @default(autoincrement())
  categoryId BigInt
  title      String @db.VarChar(128)
  url        String @db.VarChar(512)
  previewUrl String @db.VarChar(512)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  width    Int
  height   Int
  fileSize Int
  duration Float? // –í —Å–µ–∫—É–Ω–¥–∞—Ö

  tags       String? @db.VarChar(255) // –¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
  searchText String? @db.VarChar(255) // –î–ª—è –ø–æ–∏—Å–∫–∞

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: trending(1), featured(2), nsfw(4), verified(8)
  flags Int @default(0)

  usageCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  category GifCategory  @relation(fields: [categoryId], references: [id])
  messages MessageGif[]

  @@index([categoryId])
  @@index([title])
  @@index([tags])
  @@index([flags])
  @@index([usageCount])
  @@index([searchText])
}

// –°–≤—è–∑–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –º–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
model MessageSticker {
  id        BigInt @id @default(autoincrement())
  messageId BigInt
  stickerId BigInt

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  sticker Sticker @relation(fields: [stickerId], references: [id])

  @@unique([messageId, stickerId])
  @@index([messageId])
  @@index([stickerId])
}

model MessageEmoji {
  id        BigInt @id @default(autoincrement())
  messageId BigInt
  emojiId   BigInt

  message Message     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  emoji   CustomEmoji @relation(fields: [emojiId], references: [id])

  @@unique([messageId, emojiId])
  @@index([messageId])
  @@index([emojiId])
}

model MessageGif {
  id        BigInt @id @default(autoincrement())
  messageId BigInt
  gifId     BigInt

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  gif     Gif     @relation(fields: [gifId], references: [id])

  @@unique([messageId, gifId])
  @@index([messageId])
  @@index([gifId])
}

// –ü–æ–∫—É–ø–∫–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å—Ç–∏–∫–µ—Ä-–ø–∞–∫–∏
model StickerPurchase {
  id       BigInt @id @default(autoincrement())
  userId   BigInt
  packId   BigInt
  price    Int // –¶–µ–Ω–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–æ–∫—É–ø–∫–∏
  currency String @default("USD") @db.VarChar(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack StickerPack @relation(fields: [packId], references: [id])

  @@unique([userId, packId])
  @@index([userId])
  @@index([packId])
  @@index([createdAt])
}

model UserStickerPack {
  id       BigInt @id @default(autoincrement())
  userId   BigInt
  packId   BigInt
  position Int    @default(0) // –ü–æ—Ä—è–¥–æ–∫ –≤ —Å–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: favorite(1), hidden(2)
  flags Int @default(0)

  addedAt DateTime @default(now()) @db.Timestamptz(3)

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack StickerPack @relation(fields: [packId], references: [id])

  @@unique([userId, packId])
  @@index([userId])
  @@index([packId])
  @@index([position])
  @@index([flags])
}

// ===== –ü–ê–ü–ö–ò –ß–ê–¢–û–í =====

model ChatFolder {
  id          BigInt  @id @default(autoincrement())
  userId      BigInt
  name        String  @db.VarChar(64)
  description String? @db.VarChar(255)
  color       String? @db.Char(7) // HEX —Ü–≤–µ—Ç
  iconUrl     String? @db.VarChar(512)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: pinned(1), collapsed(2), archived(4), default(8)
  flags    Int @default(0)
  position Int @default(0) // –ü–æ–∑–∏—Ü–∏—è –≤ —Å–ø–∏—Å–∫–µ –ø–∞–ø–æ–∫

  // –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤
  filters Json? // –£—Å–ª–æ–≤–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

  chatCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  user  User             @relation("UserFolders", fields: [userId], references: [id], onDelete: Cascade)
  chats ChatFolderItem[]

  @@index([userId])
  @@index([position])
  @@index([flags])
  @@index([userId, position])
}

model ChatFolderItem {
  id       BigInt @id @default(autoincrement())
  folderId BigInt
  chatId   BigInt
  position Int    @default(0) // –ü–æ–∑–∏—Ü–∏—è —á–∞—Ç–∞ –≤ –ø–∞–ø–∫–µ

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: pinned(1), muted(2), archived(4)
  flags Int @default(0)

  addedAt DateTime @default(now()) @db.Timestamptz(3)

  folder ChatFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  chat   Chat       @relation("FolderItems", fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([folderId, chatId])
  @@index([folderId])
  @@index([chatId])
  @@index([position])
  @@index([flags])
}

// ===== –ö–û–ù–¢–ï–ù–¢ (YOUTUBE + INSTAGRAM) =====

model Content {
  id           BigInt        @id @default(autoincrement())
  authorId     BigInt
  type         ContentType
  status       ContentStatus @default(DRAFT)
  title        String        @db.VarChar(200)
  description  String?       @db.Text
  thumbnailUrl String?       @db.VarChar(300)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: featured(1), monetized(2), ageRestricted(4), commentsDisabled(8)
  flags Int @default(0)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  metadata Json? // duration, resolution, codec –¥–ª—è –≤–∏–¥–µ–æ; dimensions –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

  // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  viewsCount    BigInt @default(0)
  likesCount    BigInt @default(0)
  dislikesCount BigInt @default(0)
  sharesCount   BigInt @default(0)
  commentsCount Int    @default(0)

  // –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
  publishedAt DateTime? @db.Timestamptz(3)
  scheduledAt DateTime? @db.Timestamptz(3)

  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  author      User                @relation(fields: [authorId], references: [id])
  attachments ContentAttachment[]
  comments    Comment[]
  likes       Like[]
  tags        ContentTag[]
  playlists   PlaylistItem[]
  history     WatchHistory[]
  reports     Report[]

  @@index([authorId])
  @@index([type])
  @@index([status])
  @@index([publishedAt])
  @@index([viewsCount])
  @@index([likesCount])
  @@index([createdAt])
  @@index([flags])
  @@index([type, status, publishedAt])
  @@index([authorId, type, status])
}

model ContentAttachment {
  id        BigInt   @id @default(autoincrement())
  contentId BigInt
  url       String   @db.VarChar(500)
  mimeType  String   @db.VarChar(64)
  fileSize  BigInt
  metadata  Json? // width, height, duration, bitrate, etc.
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([mimeType])
}

model Comment {
  id        BigInt  @id @default(autoincrement())
  contentId BigInt
  authorId  BigInt
  parentId  BigInt? // –î–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
  text      String  @db.VarChar(1000)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: deleted(1), edited(2), pinned(4), hearted(8)
  flags Int @default(0)

  likesCount BigInt    @default(0)
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  content Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  author  User      @relation(fields: [authorId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")
  likes   Like[]

  @@index([contentId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
  @@index([likesCount])
  @@index([contentId, parentId, createdAt])
}

model Like {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  contentId BigInt?
  commentId BigInt?
  value     Int      @default(1) // 1 –¥–ª—è –ª–∞–π–∫–∞, -1 –¥–ª—è –¥–∏–∑–ª–∞–π–∫–∞
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@unique([userId, commentId])
  @@index([userId])
  @@index([contentId])
  @@index([commentId])
  @@index([createdAt])
}

model Tag {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(64)
  description String?  @db.VarChar(255)
  flags       Int      @default(0) // trending(1), official(2)
  usageCount  BigInt   @default(0)
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  contentTags ContentTag[]

  @@index([name])
  @@index([usageCount])
  @@index([flags])
}

model ContentTag {
  id        BigInt @id @default(autoincrement())
  contentId BigInt
  tagId     BigInt

  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contentId, tagId])
  @@index([contentId])
  @@index([tagId])
}

// ===== –°–û–¶–ò–ê–õ–¨–ù–ê–Ø –°–ï–¢–¨ =====

model Subscription {
  id             BigInt @id @default(autoincrement())
  subscriberId   BigInt
  subscribedToId BigInt

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: notificationsEnabled(1), premium(2)
  flags     Int      @default(1)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  subscriber   User @relation("UserSubscriptions", fields: [subscriberId], references: [id], onDelete: Cascade)
  subscribedTo User @relation("SubscribedTo", fields: [subscribedToId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, subscribedToId])
  @@index([subscriberId])
  @@index([subscribedToId])
  @@index([createdAt])
}

model Playlist {
  id           BigInt  @id @default(autoincrement())
  authorId     BigInt
  title        String  @db.VarChar(128)
  description  String? @db.VarChar(500)
  thumbnailUrl String? @db.VarChar(300)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: public(1), collaborative(2), featured(4)
  flags Int @default(1)

  itemsCount Int      @default(0)
  createdAt  DateTime @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime @updatedAt @db.Timestamptz(3)

  author User           @relation(fields: [authorId], references: [id])
  items  PlaylistItem[]

  @@index([authorId])
  @@index([flags])
  @@index([createdAt])
}

model PlaylistItem {
  id         BigInt   @id @default(autoincrement())
  playlistId BigInt
  contentId  BigInt
  position   Int
  addedAt    DateTime @default(now()) @db.Timestamptz(3)

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  content  Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([playlistId, contentId])
  @@index([playlistId, position])
  @@index([contentId])
}

model WatchHistory {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  contentId BigInt
  watchedAt DateTime @default(now()) @db.Timestamptz(3)
  watchTime Int      @default(0) // –°–µ–∫—É–Ω–¥—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  completed Boolean  @default(false)
  progress  Float    @default(0) // –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (0-1)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@index([userId])
  @@index([contentId])
  @@index([watchedAt])
  @@index([userId, watchedAt])
}

model Notification {
  id      BigInt           @id @default(autoincrement())
  userId  BigInt
  type    NotificationType
  title   String           @db.VarChar(128)
  message String           @db.VarChar(255)
  data    Json? // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (ID –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç.–¥.)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: read(1), important(2)
  flags Int @default(0)

  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  readAt    DateTime? @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([flags])
  @@index([createdAt])
  @@index([userId, flags, createdAt])
}

// ===== –§–û–†–£–ú =====

// –ö–æ—Ä–Ω–µ–≤–∞—è –º–æ–¥–µ–ª—å —Ñ–æ—Ä—É–º–∞ - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –ø–æ—Å—Ç–æ–≤
model Forum {
  id          BigInt  @id @default(autoincrement())
  name        String  @db.VarChar(128)
  slug        String  @unique @db.VarChar(64) // –î–ª—è SEO URL
  description String? @db.VarChar(500)
  logoUrl     String? @db.VarChar(300)
  bannerUrl   String? @db.VarChar(300)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: active(1), public(2), moderated(4), archived(8), featured(16)
  flags Int @default(3) // active + public by default

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä—É–º–∞
  settings Json? // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: –ø—Ä–∞–≤–∏–ª–∞, —Å—Ç–∏–ª–∏, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è

  // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  categoriesCount Int @default(0)
  postsCount      Int @default(0)
  topicsCount     Int @default(0)
  repliesCount    Int @default(0)
  usersCount      Int @default(0) // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

  // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
  lastPostAt     DateTime? @db.Timestamptz(3)
  lastPostId     BigInt? // –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø–æ—Å—Ç—É
  lastActivityAt DateTime? @db.Timestamptz(3)

  // –í–ª–∞–¥–µ–ª–µ—Ü –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—è
  ownerId   BigInt
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  // –°–≤—è–∑–∏
  owner         User                 @relation("ForumOwner", fields: [ownerId], references: [id])
  categories    ForumCategory[]      @relation("ForumCategories")
  moderators    ForumModerator[]     @relation("ForumModerators")
  configuration ForumConfiguration[] @relation("ForumConfig")
  analytics     ForumAnalytics[]     @relation("ForumAnalytics")

  @@index([slug])
  @@index([flags])
  @@index([ownerId])
  @@index([lastActivityAt])
  @@index([flags, lastActivityAt]) // –î–ª—è —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–æ—Ä—É–º–æ–≤
}

// –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã —Ñ–æ—Ä—É–º–∞ (–æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
model ForumModerator {
  id          BigInt    @id @default(autoincrement())
  forumId     BigInt
  userId      BigInt
  permissions BigInt    @default(0) // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
  assignedBy  BigInt
  assignedAt  DateTime  @default(now()) @db.Timestamptz(3)
  expiresAt   DateTime? @db.Timestamptz(3)
  isActive    Boolean   @default(true)

  forum     Forum @relation("ForumModerators", fields: [forumId], references: [id], onDelete: Cascade)
  moderator User  @relation("ForumModeratorRoles", fields: [userId], references: [id], onDelete: Cascade)
  assigner  User  @relation("AssignedForumModerators", fields: [assignedBy], references: [id], onDelete: Restrict)

  @@unique([forumId, userId])
  @@index([forumId])
  @@index([userId])
  @@index([assignedBy])
  @@index([isActive, expiresAt])
}

// –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ñ–æ—Ä—É–º–∞
model ForumCategoryModerator {
  id          BigInt    @id @default(autoincrement())
  categoryId  BigInt
  userId      BigInt
  permissions BigInt    @default(0) // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞ (64 –±–∏—Ç–∞)
  assignedBy  BigInt
  assignedAt  DateTime  @default(now()) @db.Timestamptz(3)
  expiresAt   DateTime? @db.Timestamptz(3)
  isActive    Boolean   @default(true)

  category  ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  moderator User          @relation("CategoryModerators", fields: [userId], references: [id], onDelete: Cascade)
  assigner  User          @relation("AssignedModerators", fields: [assignedBy], references: [id], onDelete: Restrict)

  @@unique([categoryId, userId])
  @@index([categoryId])
  @@index([userId])
  @@index([assignedBy])
  @@index([isActive, expiresAt])
}

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ–æ—Ä—É–º–∞
model ForumConfiguration {
  id          Int     @id @default(autoincrement())
  forumId     BigInt // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ñ–æ—Ä—É–º—É
  key         String  @db.VarChar(64)
  value       String  @db.Text
  type        String  @default("string") @db.VarChar(16) // string, number, boolean, json
  description String? @db.VarChar(255)
  isPublic    Boolean @default(false) // –î–æ—Å—Ç—É–ø–Ω–æ –ª–∏ —á–µ—Ä–µ–∑ API

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  forum Forum @relation("ForumConfig", fields: [forumId], references: [id], onDelete: Cascade)

  @@unique([forumId, key])
  @@index([forumId])
  @@index([key])
  @@index([isPublic])
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
model ForumTopicTracker {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  postId    BigInt
  lastRead  DateTime @default(now()) @db.Timestamptz(3)
  readCount Int      @default(0) // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

  user User      @relation("ForumTrackers", fields: [userId], references: [id], onDelete: Cascade)
  post ForumPost @relation("PostTrackers", fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@index([lastRead])
}

model ForumCategory {
  id          BigInt  @id @default(autoincrement())
  forumId     BigInt // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ñ–æ—Ä—É–º—É
  name        String  @db.VarChar(64)
  slug        String  @unique @db.VarChar(64) // –î–ª—è SEO-–¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö URL
  description String? @db.VarChar(255)
  color       String? @db.Char(7)
  icon        String? @db.VarChar(32) // Unicode emoji –∏–ª–∏ icon class
  position    Int     @default(0)
  parentId    BigInt? // –î–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–º–∞–∫—Å 3 —É—Ä–æ–≤–Ω—è)
  level       Int     @default(0) // –£—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ (0-2)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: active(1), moderated(2), private(4), archived(8)
  flags Int @default(1)

  // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  postsCount   Int @default(0)
  repliesCount Int @default(0)
  topicsCount  Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  // –°–≤—è–∑–∏
  forum       Forum                     @relation("ForumCategories", fields: [forumId], references: [id], onDelete: Cascade)
  parent      ForumCategory?            @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ForumCategory[]           @relation("CategoryHierarchy")
  posts       ForumPost[]
  permissions ForumCategoryPermission[]
  moderators  ForumCategoryModerator[]
  analytics   ForumAnalytics[]          @relation("CategoryAnalytics")

  @@index([forumId])
  @@index([position])
  @@index([flags])
  @@index([postsCount])
  @@index([parentId])
  @@index([slug])
  @@index([level]) // –î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
  @@index([parentId, position]) // –î–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–≤–æ–¥–∞
  @@index([forumId, position]) // –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Ñ–æ—Ä—É–º–µ
}

model ForumCategoryPermission {
  id          BigInt   @id @default(autoincrement())
  categoryId  BigInt
  roleId      BigInt
  permissions BigInt   @default(0) // –ë–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  category ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  role     RoleGlobally  @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([categoryId, roleId])
  @@index([categoryId])
  @@index([roleId])
}

model ForumPost {
  id         BigInt @id @default(autoincrement())
  categoryId BigInt
  authorId   BigInt
  title      String @db.VarChar(200)
  content    String @db.Text
  slug       String @unique @db.VarChar(200) // SEO-–¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π URL

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: pinned(1), locked(2), featured(4), solved(8), hidden(16), deleted(32)
  flags Int @default(0)

  // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  viewsCount    Int @default(0)
  repliesCount  Int @default(0)
  likesCount    Int @default(0)
  dislikesCount Int @default(0)

  // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  lastReplyAt DateTime? @db.Timestamptz(3)
  lastReplyBy BigInt? // ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∏–≤—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

  // –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (PostgreSQL tsvector –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
  searchVector Unsupported("tsvector")?

  // –°–≤—è–∑–∏
  category      ForumCategory       @relation(fields: [categoryId], references: [id])
  author        User                @relation(fields: [authorId], references: [id])
  replies       ForumReply[]
  votes         ForumVote[]         @relation("PostVotes")
  subscriptions ForumSubscription[]
  tags          ForumPostTag[]
  attachments   ForumAttachment[]
  trackers      ForumTopicTracker[] @relation("PostTrackers")
  seoPost       ForumPostSEO?       @relation("PostSEO")
  hotTopics     ForumHotTopics[]    @relation("HotTopics")

  @@index([categoryId])
  @@index([authorId])
  @@index([flags])
  @@index([createdAt])
  @@index([lastReplyAt])
  @@index([viewsCount])
  @@index([likesCount])
  @@index([slug])
  @@index([categoryId, flags, lastReplyAt]) // –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–µ–º
  @@index([categoryId, flags, createdAt]) // –î–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
}

model ForumReply {
  id       BigInt  @id @default(autoincrement())
  postId   BigInt
  authorId BigInt
  content  String  @db.Text
  parentId BigInt? // –î–ª—è –¥—Ä–µ–≤–æ–≤–∏–¥–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: deleted(1), edited(2), solution(4), hidden(8)
  flags Int @default(0)

  likesCount    Int @default(0)
  dislikesCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  // –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (PostgreSQL tsvector –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
  searchVector Unsupported("tsvector")?

  // –°–≤—è–∑–∏
  post        ForumPost         @relation(fields: [postId], references: [id], onDelete: Cascade)
  author      User              @relation(fields: [authorId], references: [id])
  parent      ForumReply?       @relation("ReplyHierarchy", fields: [parentId], references: [id])
  children    ForumReply[]      @relation("ReplyHierarchy")
  votes       ForumVote[]       @relation("ReplyVotes")
  attachments ForumAttachment[]

  @@index([postId])
  @@index([authorId])
  @@index([createdAt])
  @@index([flags])
  @@index([parentId])
  @@index([postId, createdAt]) // –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ç–µ–º–µ
}

model ForumVote {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  postId    BigInt?
  replyId   BigInt?
  value     Int // 1 –¥–ª—è upvote, -1 –¥–ª—è downvote
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  post  ForumPost?  @relation("PostVotes", fields: [postId], references: [id], onDelete: Cascade)
  reply ForumReply? @relation("ReplyVotes", fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, replyId])
  @@index([userId])
  @@index([postId])
  @@index([replyId])
  @@index([value])
}

model ForumSubscription {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  postId    BigInt
  flags     Int      @default(1) // notifications(1), email(2), instant(4)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

model ForumTag {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(32)
  description String?  @db.VarChar(255)
  color       String?  @db.Char(7)
  usageCount  Int      @default(0)
  flags       Int      @default(1) // active(1), moderated(2)
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  posts ForumPostTag[]

  @@index([name])
  @@index([usageCount])
  @@index([flags])
}

model ForumPostTag {
  id     BigInt @id @default(autoincrement())
  postId BigInt
  tagId  BigInt

  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  ForumTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

model ForumAttachment {
  id           BigInt  @id @default(autoincrement())
  postId       BigInt?
  replyId      BigInt?
  fileName     String  @db.VarChar(255)
  originalName String  @db.VarChar(255)
  mimeType     String  @db.VarChar(100)
  fileSize     BigInt
  url          String  @db.VarChar(500)
  thumbnailUrl String? @db.VarChar(500)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  post  ForumPost?  @relation(fields: [postId], references: [id], onDelete: Cascade)
  reply ForumReply? @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([replyId])
  @@index([mimeType])
}

// –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ä—É–º–∞
model ForumModerationLog {
  id           BigInt           @id @default(autoincrement())
  moderatorId  BigInt
  targetUserId BigInt?
  postId       BigInt?
  replyId      BigInt?
  action       ModerationAction
  reason       String?          @db.VarChar(500)
  metadata     Json? // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –¥–µ–π—Å—Ç–≤–∏–∏
  createdAt    DateTime         @default(now()) @db.Timestamptz(3)

  moderator  User  @relation("ModeratorActions", fields: [moderatorId], references: [id])
  targetUser User? @relation("ModeratedUsers", fields: [targetUserId], references: [id])

  @@index([moderatorId])
  @@index([targetUserId])
  @@index([postId])
  @@index([replyId])
  @@index([action])
  @@index([createdAt])
}

// ===== –ú–û–î–ï–†–ê–¶–ò–Ø –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====

model Report {
  id          BigInt       @id @default(autoincrement())
  reporterId  BigInt
  userId      BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  contentId   BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
  postId      BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ –ø–æ—Å—Ç —Ñ–æ—Ä—É–º–∞
  replyId     BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ –æ—Ç–≤–µ—Ç —Ñ–æ—Ä—É–º–∞
  messageId   BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
  reason      ReportReason
  status      ReportStatus @default(PENDING)
  description String?      @db.VarChar(500)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: reviewed(1), resolved(2), dismissed(4), escalated(8)
  flags Int @default(0)

  // –ú–æ–¥–µ—Ä–∞—Ü–∏—è
  reviewedBy BigInt?
  reviewedAt DateTime?        @db.Timestamptz(3)
  resolution String?          @db.VarChar(500)
  action     ModerationAction @default(NONE)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  reporter User     @relation("ReportedBy", fields: [reporterId], references: [id])
  user     User?    @relation("ReportedUser", fields: [userId], references: [id])
  content  Content? @relation(fields: [contentId], references: [id])
  reviewer User?    @relation("ReviewedReports", fields: [reviewedBy], references: [id])

  @@index([reporterId])
  @@index([userId])
  @@index([contentId])
  @@index([postId])
  @@index([replyId])
  @@index([messageId])
  @@index([reason])
  @@index([status])
  @@index([flags])
  @@index([createdAt])
  @@index([reviewedBy])
  @@index([status, createdAt]) // –î–ª—è –æ—á–µ—Ä–µ–¥–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
}

// ===== –ù–ê–°–¢–†–û–ô–ö–ò –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====

model RefreshToken {
  id        BigInt   @id @default(autoincrement())
  sessionId BigInt
  userId    BigInt   @unique
  token     String   @unique @db.VarChar(255)
  tokenHash String   @unique @db.VarChar(255) // –•–µ—à —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  expiresAt DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  deviceId  String?  @unique
  ipAddress String?  @db.Inet
  userAgent String?  @db.VarChar(512)
  isRevoked Boolean  @default(false)
  isUsed    Boolean  @default(false) // For reuse detection (Signal/Stripe pattern)

  session Session @relation(fields: [sessionId], references: [id])
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
  @@index([isRevoked])
  @@index([isUsed])
  @@index([userId, isRevoked])
  @@index([userId, isUsed])
}

model RefreshTokenBlacklist {
  id        BigInt   @id @default(autoincrement())
  tokenHash String   @unique @db.VarChar(64)
  userId    BigInt
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  expiresAt DateTime @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
}

model ContactList {
  id          BigInt   @id @default(autoincrement())
  userId      BigInt
  contactId   BigInt
  displayName String?  @db.VarChar(64)
  phoneNumber String?  @db.VarChar(15)
  addedAt     DateTime @default(now()) @db.Timestamptz(3)
  flags       Int      @default(0) // blocked(1), favorite(2)

  user    User @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
  contact User @relation("ContactOf", fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([userId, contactId])
  @@index([userId])
  @@index([contactId])
  @@index([flags])
}

model UserSettings {
  id     BigInt @id @default(autoincrement())
  userId BigInt @unique

  // –û–±—ä–µ–¥–∏–Ω–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ JSON –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –∫–æ–ª–æ–Ω–æ–∫
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { theme: string, language: string, fontSize: number, animations: boolean }
  uiSettings    Json? // theme, language, fontSize, animations
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { enabled: boolean, sound: boolean, vibration: boolean, types: string[] }
  notifications Json? // enabled, sound, vibration, types
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { lastSeen: string, profilePhoto: string, status: string, messaging: string }
  privacy       Json? // lastSeen, profilePhoto, status, messaging
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { biometric: boolean, twoFactor: boolean, sessionTimeout: number }
  security      Json? // biometric, twoFactor, sessionTimeout
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { autoDownload: string, backup: boolean, quality: string }
  dataStorage   Json? // autoDownload, backup, quality settings
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { autoplay: boolean, captions: boolean, recommendations: boolean }
  content       Json? // autoplay, captions, recommendations
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { betaFeatures: string[], labs: boolean }
  experimental  Json? // beta features, labs
  blockedUsers  BigInt[] // –ú–∞—Å—Å–∏–≤ ID –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChatSettings {
  id       BigInt @id @default(autoincrement())
  chatId   BigInt @unique
  settings Json? // slowMode, maxMembers, joinApproval, autoDelete, etc.

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
}

model NotificationSettings {
  id               BigInt   @id @default(autoincrement())
  userId           BigInt
  chatId           BigInt?
  notificationType String   @db.VarChar(32)
  flags            Int      @default(7) // enabled(1), sound(2), vibration(4)
  createdAt        DateTime @default(now()) @db.Timestamptz(3)
  updatedAt        DateTime @updatedAt @db.Timestamptz(3)

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  chat Chat? @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId, notificationType])
  @@index([userId])
  @@index([chatId])
  @@index([notificationType])
}

// ===== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–û–î–ï–õ–ò –î–õ–Ø –§–û–†–£–ú–ê =====

// SEO –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä—É–º–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
model ForumPostSEO {
  id           BigInt  @id @default(autoincrement())
  postId       BigInt  @unique
  metaTitle    String? @db.VarChar(70) // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤
  metaDesc     String? @db.VarChar(160) // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤
  keywords     String? @db.VarChar(255)
  canonicalUrl String? @db.VarChar(500)
  ogImage      String? @db.VarChar(500)
  schema       Json? // –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Schema.org

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  post ForumPost @relation("PostSEO", fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

// –°–∏—Å—Ç–µ–º–∞ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –∏ –∞—á–∏–≤–æ–∫
model ForumReputation {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  points Int    @default(0)
  level  Int    @default(1)
  badges Json? // –ú–∞—Å—Å–∏–≤ –∑–Ω–∞—á–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  postsCreated    Int @default(0)
  repliesCreated  Int @default(0)
  likesReceived   Int @default(0)
  likesGiven      Int @default(0)
  bestAnswers     Int @default(0)
  moderationScore Int @default(0)

  lastCalculated DateTime @default(now()) @db.Timestamptz(3)

  user User @relation("UserReputation", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([points])
  @@index([level])
  @@index([lastCalculated])
}

// –ö—ç—à –≥–æ—Ä—è—á–∏—Ö —Ç–µ–º
model ForumHotTopics {
  id       BigInt  @id @default(autoincrement())
  postId   BigInt
  score    Float // –ê–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–π —Å–∫–æ—Ä –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
  position Int // –ü–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
  period   String  @db.VarChar(16) // hour, day, week, month
  region   String? @db.VarChar(8) // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º

  calculatedAt DateTime @default(now()) @db.Timestamptz(3)
  expiresAt    DateTime @db.Timestamptz(3)

  post ForumPost @relation("HotTopics", fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, period, region])
  @@index([period, score])
  @@index([position, period])
  @@index([expiresAt])
}

// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ñ–æ—Ä—É–º–∞
model ForumAnalytics {
  id         BigInt   @id @default(autoincrement())
  date       DateTime @db.Date
  forumId    BigInt? // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –≤—Å–µ–≥–æ —Ñ–æ—Ä—É–º–∞
  categoryId BigInt? // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

  // –ú–µ—Ç—Ä–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  newPosts       Int @default(0)
  newReplies     Int @default(0)
  newUsers       Int @default(0)
  totalViews     Int @default(0)
  uniqueVisitors Int @default(0)
  avgSessionTime Int @default(0) // –í —Å–µ–∫—É–Ω–¥–∞—Ö

  // –ú–µ—Ç—Ä–∏–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏
  likesGiven    Int @default(0)
  sharesCount   Int @default(0)
  searchQueries Int @default(0)

  // –ú–æ–¥–µ—Ä–∞—Ü–∏—è
  reportsCreated   Int @default(0)
  actionsPerformed Int @default(0)

  forum    Forum?         @relation("ForumAnalytics", fields: [forumId], references: [id])
  category ForumCategory? @relation("CategoryAnalytics", fields: [categoryId], references: [id])

  @@unique([date, forumId])
  @@unique([date, categoryId])
  @@index([date])
  @@index([forumId])
  @@index([categoryId])
  @@index([totalViews])
  @@index([uniqueVisitors])
}

// –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ñ–æ—Ä—É–º–∞
model ForumNotificationQueue {
  id         BigInt @id @default(autoincrement())
  userId     BigInt
  type       String @db.VarChar(32) // mention, reply, like, follow
  entityType String @db.VarChar(16) // post, reply, user
  entityId   BigInt

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
  isRead  Boolean @default(false)
  isEmail Boolean @default(false)
  isPush  Boolean @default(false)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  title   String @db.VarChar(128)
  message String @db.VarChar(255)
  data    Json? // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

  // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  sentAt    DateTime? @db.Timestamptz(3)
  readAt    DateTime? @db.Timestamptz(3)

  user User @relation("ForumNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([type, createdAt])
  @@index([isRead, sentAt])
  @@index([entityType, entityId])
}

// ===== –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê =====

model ChatStatsCache {
  chatId           BigInt    @id
  messageCount     Int       @default(0)
  participantCount Int       @default(0)
  lastActivity     DateTime? @db.Timestamptz(3)
  storageBytes     BigInt    @default(0)
  lastUpdated      DateTime  @default(now()) @db.Timestamptz(3)

  @@index([lastActivity])
  @@index([lastUpdated])
}

model UserStatsCache {
  userId        BigInt    @id
  messagesSent  Int       @default(0)
  chatsCount    Int       @default(0)
  contactsCount Int       @default(0)
  storageUsed   BigInt    @default(0)
  lastActivity  DateTime? @db.Timestamptz(3)
  lastUpdated   DateTime  @default(now()) @db.Timestamptz(3)

  @@index([lastActivity])
  @@index([lastUpdated])
}

model ContentStatsCache {
  contentId    BigInt   @id
  hourlyViews  Json? // –ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
  dailyViews   Json? // –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  demographics Json? // –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏
  engagement   Json? // –ú–µ—Ç—Ä–∏–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏
  revenue      Json? // –î–∞–Ω–Ω—ã–µ –æ –¥–æ—Ö–æ–¥–∞—Ö
  lastUpdated  DateTime @default(now()) @db.Timestamptz(3)

  @@index([lastUpdated])
}

// ===== –ê–†–•–ò–í–ò–†–û–í–ê–ù–ò–ï =====

model MessageArchive {
  id              BigInt      @id @default(autoincrement())
  originalId      BigInt
  chatId          BigInt
  senderId        BigInt
  content         Bytes
  messageType     MessageType
  createdAt       DateTime    @db.Timestamptz(3)
  archiveDate     DateTime    @default(now()) @db.Timestamptz(3)
  compressionType String      @default("gzip") @db.VarChar(16)

  @@index([chatId, createdAt])
  @@index([originalId])
  @@index([archiveDate])
}

model ContentArchive {
  id              BigInt      @id @default(autoincrement())
  originalId      BigInt
  authorId        BigInt
  type            ContentType
  metadata        Json // –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  archiveDate     DateTime    @default(now()) @db.Timestamptz(3)
  archiveReason   String      @db.VarChar(64) // deleted, expired, compliance
  compressionType String      @default("gzip") @db.VarChar(16)

  @@index([originalId])
  @@index([authorId])
  @@index([type])
  @@index([archiveDate])
}

// ===== –ü–û–ò–°–ö–û–í–´–ô –ö–≠–®–ò =====

model SearchCache {
  queryHash String   @id @db.VarChar(32)
  results   Json
  expiresAt DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  hitCount  Int      @default(1)

  @@index([expiresAt])
  @@index([hitCount])
  @@index([createdAt])
}

model TrendingCache {
  id        BigInt   @id @default(autoincrement())
  type      String   @db.VarChar(32) // tags, creators, content
  data      Json // –¢—Ä–µ–Ω–¥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  region    String?  @db.VarChar(8) // –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ä–µ–≥–∏–æ–Ω
  expiresAt DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  @@index([type])
  @@index([region])
  @@index([expiresAt])
}
