// –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –º—É–ª—å—Ç–∏–º–µ–¥–∏–π–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
// –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä, –≤–∏–¥–µ–æ—Ö–æ—Å—Ç–∏–Ω–≥, —Å–æ—Ü–∏–∞–ª—å–Ω—É—é —Å–µ—Ç—å –∏ —Ñ–æ—Ä—É–º
// 
// –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:
// 1. BigInt ID –≤–º–µ—Å—Ç–æ UUID (—ç–∫–æ–Ω–æ–º–∏—è 75% –º–µ—Å—Ç–∞ –≤ –∏–Ω–¥–µ–∫—Å–∞—Ö –∏ FK)
// 2. –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ Boolean –ø–æ–ª–µ–π  
// 3. –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ VARCHAR —Å —Ç–æ—á–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
// 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
// 5. Timestamptz(3) –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (—ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞)
// 6. –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
// 7. JSON –¥–ª—è –≥–∏–±–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫
// 8. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
// 9. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
// 10. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è foreign key constraints –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
  output          = "../generated/client"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pg_trgm, btree_gin, btree_gist]
}

// ===== ENUMS =====

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
  DELETED
  RESTRICTED
}

enum ChatType {
  PRIVATE
  GROUP
  CHANNEL
  COMMUNITY
}

enum ChatRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
  SUBSCRIBER
}

enum MessageType {
  SYSTEM
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  DOCUMENT
  STICKER
  VOICE
  VIDEO_NOTE
  LOCATION
  CONTACT
  POLL
  DICE
  GAME
  EMOJI
  GIF
  MARKDOWN
  CUSTOM_EMOJI
  STICKER_PACK
}

enum ContentType {
  VIDEO
  SHORT_VIDEO
  LIVE_STREAM
  PODCAST
  IMAGE_POST
  TEXT_POST
  STORY
  THREAD
  FORUM_POST
  FORUM_REPLY
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  UNLISTED
  PRIVATE
  SCHEDULED
  ARCHIVED
  DELETED
  UNDER_REVIEW
}

enum SubscriptionType {
  FREE
  PREMIUM
  CREATOR
  BUSINESS
}

enum NotificationType {
  MESSAGE
  REACTION
  COMMENT
  LIKE
  FOLLOW
  MENTION
  VIDEO_UPLOAD
  LIVE_START
  COMMUNITY_POST
}

enum ReportReason {
  SPAM
  HARASSMENT
  HATE_SPEECH
  VIOLENCE
  COPYRIGHT
  ADULT_CONTENT
  MISINFORMATION
  SCAM
  FAKE_ACCOUNT
  IMPERSONATION
  TERRORISM
  SELF_HARM
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
  ESCALATED
}

enum ModerationAction {
  NONE
  MOVE

  WARN
  PIN
  UNPIN
  FEATURE
  UNFEATURE
  LOCK
  UNLOCK
  TIMEOUT
  DELETE
  SUSPEND_USER
  BAN_USER
  SHADOWBAN
}

enum ChatPermission {
  SEND_MESSAGES
  SEND_MEDIA
  ADD_MEMBERS
  REMOVE_MEMBERS
  EDIT_INFO
  PIN_MESSAGES
  DELETE_MESSAGES
  BAN_MEMBERS
  MANAGE_PERMISSIONS
}

// ===== –û–°–ù–û–í–ù–´–ï –ú–û–î–ï–õ–ò =====

model RoleGlobally {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(32)
  flags       Int      @default(0) // founder(1), admin(2), moderator(4), verified(8)
  permissions Json?
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)

  users User[]

  @@index([name])
  @@index([flags])
}

model User {
  id          BigInt  @id @default(autoincrement())
  email       String  @unique @db.VarChar(320) // RFC 5321 compliant
  username    String  @unique @db.VarChar(32)
  password    String  @db.VarChar(128) // –•—ç—à –ø–∞—Ä–æ–ª—è
  supabaseId  String? @unique @db.VarChar(36) // Supabase UUID
  fullName    String? @db.VarChar(128)
  bio         String? @db.VarChar(500)
  avatarUrl   String? @db.VarChar(512)
  bannerUrl   String? @db.VarChar(512)
  color       String? @db.Char(7) // HEX —Ü–≤–µ—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
  phoneNumber String? @unique @db.VarChar(15)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: verified(1), bot(2), online(4), creator(8), live(16), premium(32), staff(64)
  // –í–ê–ñ–ù–û: –ú–∞–∫—Å–∏–º—É–º 31 —Ñ–ª–∞–≥ –¥–ª—è Int (2^31-1)
  flags  Int        @default(0)
  status UserStatus @default(ACTIVE)

  lastSeen  DateTime? @db.Timestamptz(3)
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)
  roleId    BigInt? // Nullable, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ—Å—Ç–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

  // –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ (PostgreSQL tsvector –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞)
  searchVector Unsupported("tsvector")?
  timezone     String?                  @db.VarChar(32)
  locale       String?                  @db.VarChar(10) // –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è locale —Ç–∏–ø–∞ en-US

  // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏)
  subscribersCount   Int    @default(0)
  subscriptionsCount Int    @default(0)
  videosCount        Int    @default(0)
  postsCount         Int    @default(0)
  totalViews         BigInt @default(0)
  totalLikes         BigInt @default(0)
  reputation         Int    @default(0) // –î–ª—è —Ñ–æ—Ä—É–º–∞

  forumReplies ForumReply[]
  forumPosts   ForumPost[]

  // –°–≤—è–∑–∏
  role                   RoleGlobally?           @relation(fields: [roleId], references: [id])
  devices                Device[]
  sessions               Session[]
  chatsCreated           Chat[]                  @relation("chatsCreated")
  chatParticipants       ChatParticipant[]
  messages               Message[]               @relation("messagesSent")
  refreshTokens          RefreshToken[]
  refreshTokensBlacklist RefreshTokenBlacklist[]
  userCrypto             UserCrypto?
  messageReactions       MessageReaction[]
  messageReads           MessageRead[]
  contactsAdded          ContactList[]           @relation("UserContacts")
  contactOf              ContactList[]           @relation("ContactOf")
  userSettings           UserSettings?
  notificationSettings   NotificationSettings[]

  // –ö–æ–Ω—Ç–µ–Ω—Ç –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  contents        Content[]
  comments        Comment[]
  likes           Like[]
  subscriptions   Subscription[] @relation("UserSubscriptions")
  subscribers     Subscription[] @relation("SubscribedTo")
  playlists       Playlist[]
  watchHistory    WatchHistory[]
  notifications   Notification[]
  reports         Report[]       @relation("ReportedBy")
  reportedContent Report[]       @relation("ReportedUser")
  reviewedReports Report[]       @relation("ReviewedReports")

  // Stickers, Emojis –∏ Media
  createdStickerPacks StickerPack[]     @relation("CreatedStickerPacks")
  stickerPurchases    StickerPurchase[]
  userStickerPacks    UserStickerPack[]
  createdEmojis       CustomEmoji[]     @relation("CreatedEmojis")
  chatFolders         ChatFolder[]      @relation("UserFolders")

  // Security
  securityAudits      SecurityAuditLog[] @relation("SecurityAudits")
  securityResolutions SecurityAuditLog[] @relation("SecurityResolver")

  @@index([email])
  @@index([username])
  @@index([phoneNumber])
  @@index([roleId])
  @@index([status, flags])
  @@index([lastSeen])
  @@index([createdAt])
  @@index([status, deletedAt])
  @@index([subscribersCount])
  @@index([totalViews])
  @@index([reputation]) // –î–ª—è —Ñ–æ—Ä—É–º–∞
  @@index([flags, status]) // –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  @@index([createdAt, flags]) // –î–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
}

model Device {
  id            BigInt    @id @default(autoincrement())
  userId        BigInt
  deviceId      String    @unique
  deviceName    String?   @db.VarChar(64)
  deviceType    String?   @db.VarChar(32)
  deviceVersion String?   @db.VarChar(32)
  ipAddress     String?   @db.Inet
  userAgent     String?   @db.VarChar(512) // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö UA
  fingerprint   String?   @db.VarChar(256) // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  flags         Int       @default(1) // isActive(1), trusted(2)
  lastUsed      DateTime? @db.Timestamptz(3)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@index([userId])
  @@index([deviceId])
  @@index([userId, flags]) // –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–π
  @@index([lastUsed])
}

model Session {
  id           BigInt    @id @default(autoincrement())
  userId       BigInt // ‚úÖ –£–±—Ä–∞–ª–∏ @unique - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–Ω–æ–≥–æ —Å–µ—Å—Å–∏–π
  deviceId     BigInt    @unique // ‚úÖ –û—Å—Ç–∞–≤–∏–ª–∏ @unique - –æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  ratchetState Bytes
  sessionKey   String?   @db.VarChar(256)
  expiresAt    DateTime? @db.Timestamptz(3)
  createdAt    DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(3)
  flags        Int       @default(1) // isActive(1)

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  device       Device         @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  RefreshToken RefreshToken[]

  @@unique([userId, deviceId]) // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è –Ω–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å+—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  @@index([userId])
  @@index([deviceId])
  @@index([userId, flags])
  @@index([expiresAt])
  @@index([sessionKey])
}

model UserCrypto {
  id                BigInt   @id @default(autoincrement())
  userId            BigInt   @unique
  identityKeyPublic String   @db.VarChar(128)
  createdAt         DateTime @default(now()) @db.Timestamptz(3)
  updatedAt         DateTime @updatedAt @db.Timestamptz(3)

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  signedPreKeys      SignedPreKey[]
  oneTimePreKeys     OneTimePreKey[]
  usedOneTimePreKeys UsedOneTimePreKey[]

  @@index([userId])
}

model SignedPreKey {
  id           BigInt    @id @default(autoincrement())
  userCryptoId BigInt
  keyId        Int
  publicKey    String    @db.VarChar(128)
  signature    String    @db.VarChar(128)
  createdAt    DateTime  @default(now()) @db.Timestamptz(3)
  flags        Int       @default(0) // isUsed(1)
  expiresAt    DateTime? @db.Timestamptz(3)

  userCrypto UserCrypto @relation(fields: [userCryptoId], references: [id], onDelete: Cascade)

  @@unique([userCryptoId, keyId])
  @@index([userCryptoId])
  @@index([flags])
  @@index([expiresAt])
}

model OneTimePreKey {
  id           BigInt   @id @default(autoincrement())
  userCryptoId BigInt
  keyId        Int
  publicKey    String   @db.VarChar(128)
  createdAt    DateTime @default(now()) @db.Timestamptz(3)
  flags        Int      @default(0) // isUsed(1)

  userCrypto UserCrypto @relation(fields: [userCryptoId], references: [id], onDelete: Cascade)

  @@unique([userCryptoId, keyId])
  @@index([userCryptoId])
  @@index([flags])
  @@index([createdAt])
}

model UsedOneTimePreKey {
  id           BigInt   @id @default(autoincrement())
  userCryptoId BigInt
  keyId        Int
  usedAt       DateTime @default(now()) @db.Timestamptz(3)

  userCrypto UserCrypto @relation(fields: [userCryptoId], references: [id], onDelete: Cascade)

  @@unique([userCryptoId, keyId])
  @@index([userCryptoId])
  @@index([usedAt])
}

// ===== SECURITY AUDIT =====

model SecurityAuditLog {
  id          BigInt    @id @default(autoincrement())
  userId      BigInt?
  eventType   String    @db.VarChar(50)
  severity    String    @db.VarChar(20) // LOW, MEDIUM, HIGH, CRITICAL
  description String    @db.VarChar(500)
  ipAddress   String?   @db.Inet
  userAgent   String?   @db.VarChar(512)
  metadata    Json?
  timestamp   DateTime  @default(now()) @db.Timestamptz(3)
  resolvedAt  DateTime? @db.Timestamptz(3)
  resolvedBy  BigInt?

  // Relations
  user     User? @relation("SecurityAudits", fields: [userId], references: [id], onDelete: SetNull)
  resolver User? @relation("SecurityResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@index([ipAddress])
  @@index([userId, timestamp])
  @@index([eventType, timestamp])
  @@index([severity, timestamp])
}

// ===== –ú–ï–°–°–ï–ù–î–ñ–ï–† =====

model Chat {
  id          BigInt   @id @default(autoincrement())
  type        ChatType
  createdById BigInt
  title       String?  @db.VarChar(128)
  description String?  @db.VarChar(500)
  avatarUrl   String?  @db.VarChar(200)
  bannerUrl   String?  @db.VarChar(200)
  color       String?  @db.Char(7) // HEX —Ü–≤–µ—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: archived(1), public(2), verified(4), premium(8)
  flags Int @default(0)

  inviteLink      String?   @unique @db.VarChar(64)
  memberCount     Int       @default(0)
  lastMessageAt   DateTime? @db.Timestamptz(3)
  lastMessageText String?   @db.VarChar(100) // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–µ–≤—å—é
  createdAt       DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt       DateTime? @db.Timestamptz(3)

  createdBy            User                   @relation("chatsCreated", fields: [createdById], references: [id])
  participants         ChatParticipant[]
  messages             Message[]
  pinnedMessageId      BigInt?
  pinnedMessage        Message?               @relation("PinnedMessage", fields: [pinnedMessageId], references: [id])
  chatSettings         ChatSettings?
  notificationSettings NotificationSettings[]
  customEmojis         CustomEmoji[]          @relation("CustomEmojis")
  folderItems          ChatFolderItem[]       @relation("FolderItems")

  @@index([type])
  @@index([createdById])
  @@index([flags])
  @@index([lastMessageAt])
  @@index([memberCount])
  @@index([type, flags])
  @@index([createdAt])
  @@index([deletedAt])
}

model ChatParticipant {
  id       BigInt    @id @default(autoincrement())
  chatId   BigInt
  userId   BigInt
  role     ChatRole  @default(MEMBER)
  joinedAt DateTime  @default(now()) @db.Timestamptz(3)
  leftAt   DateTime? @db.Timestamptz(3)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: admin(1), owner(2), muted(4), banned(8)
  flags      Int       @default(0)
  mutedUntil DateTime? @db.Timestamptz(3)

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([chatId])
  @@index([userId])
  @@index([role])
  @@index([joinedAt])
  @@index([leftAt])
  @@index([chatId, role])
  @@index([userId, leftAt])
}

model Message {
  id          BigInt      @id @default(autoincrement())
  chatId      BigInt
  senderId    BigInt
  content     Bytes // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
  header      Bytes // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  messageType MessageType @default(TEXT)
  createdAt   DateTime    @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(3)
  editedAt    DateTime?   @db.Timestamptz(3)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: deleted(1), edited(2), forwarded(4), pinned(8)
  flags     Int       @default(0)
  deletedAt DateTime? @db.Timestamptz(3)

  replyToId       BigInt?
  forwardedFromId BigInt?
  threadId        BigInt? // –î–ª—è —Ç—Ä–µ–¥–æ–≤ –≤ —á–∞—Ç–∞—Ö
  replyDepth      Int     @default(0) // –ì–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤ (–º–∞–∫—Å 10)

  chat            Chat                @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender          User                @relation("messagesSent", fields: [senderId], references: [id])
  replyTo         Message?            @relation("ReplyTo", fields: [replyToId], references: [id])
  replies         Message[]           @relation("ReplyTo")
  forwardedFrom   Message?            @relation("ForwardedFrom", fields: [forwardedFromId], references: [id])
  forwards        Message[]           @relation("ForwardedFrom")
  thread          MessageThread?      @relation("ThreadMessage", fields: [threadId], references: [id])
  attachments     MessageAttachment[]
  reactions       MessageReaction[]
  edits           MessageEdit[]
  pinnedIn        Chat[]              @relation("PinnedMessage")
  messageReads    MessageRead[]
  messageStickers MessageSticker[]
  messageEmojis   MessageEmoji[]
  messageGifs     MessageGif[]

  @@index([chatId, createdAt])
  @@index([senderId])
  @@index([messageType])
  @@index([flags])
  @@index([replyToId])
  @@index([forwardedFromId])
  @@index([threadId])
  @@index([replyDepth]) // –î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≥–ª—É–±–∏–Ω—ã
  @@index([chatId, flags, createdAt])
  @@index([deletedAt])
}

model MessageThread {
  id        BigInt   @id @default(autoincrement())
  chatId    BigInt
  creatorId BigInt
  title     String?  @db.VarChar(128)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)
  flags     Int      @default(0) // active(1), locked(2)

  messages Message[] @relation("ThreadMessage")

  @@index([chatId])
  @@index([creatorId])
  @@index([createdAt])
}

model MessageEdit {
  id        BigInt   @id @default(autoincrement())
  messageId BigInt
  content   Bytes
  editedAt  DateTime @default(now()) @db.Timestamptz(3)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([editedAt])
}

model MessageAttachment {
  id          BigInt   @id @default(autoincrement())
  messageId   BigInt
  fileName    String   @db.VarChar(128)
  mimeType    String   @db.VarChar(64)
  fileHash    String   @db.VarChar(64)
  fileKey     String   @db.VarChar(64)
  fileIV      String   @db.VarChar(32)
  fileSize    Int
  fileType    String   @db.VarChar(16)
  thumbnail   String?  @db.VarChar(200)
  description String?  @db.VarChar(255)
  url         String   @db.VarChar(512)
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([mimeType])
  @@index([fileType])
  @@index([fileHash])
}

model MessageReaction {
  id        BigInt   @id @default(autoincrement())
  messageId BigInt
  userId    BigInt
  reaction  String   @db.VarChar(32) // –ù–∞–ø—Ä–∏–º–µ—Ä, "üëç", "‚ù§Ô∏è", "üòÇ" 
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, reaction])
  @@index([messageId])
  @@index([userId])
  @@index([reaction])
}

model MessageRead {
  id        BigInt    @id @default(autoincrement())
  messageId BigInt
  userId    BigInt
  readAt    DateTime? @db.Timestamptz(3)

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@index([readAt])
  @@index([userId, readAt])
}

// ===== –°–¢–ò–ö–ï–†–´, –≠–ú–û–î–ñ–ò –ò –ú–ï–î–ò–ê =====

model StickerPack {
  id           BigInt  @id @default(autoincrement())
  name         String  @db.VarChar(64)
  title        String  @db.VarChar(128)
  description  String? @db.VarChar(255)
  authorId     BigInt?
  thumbnailUrl String  @db.VarChar(512)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: premium(1), animated(2), official(4), nsfw(8), disabled(16)
  flags    Int     @default(0)
  price    Int     @default(0) // –í —Ü–µ–Ω—Ç–∞—Ö, 0 = –±–µ—Å–ø–ª–∞—Ç–Ω–æ
  category String? @db.VarChar(32)
  tags     String? @db.VarChar(255) // –¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

  downloadCount Int @default(0)
  usageCount    Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  author    User?             @relation("CreatedStickerPacks", fields: [authorId], references: [id])
  stickers  Sticker[]
  purchases StickerPurchase[]
  userPacks UserStickerPack[]

  @@index([authorId])
  @@index([flags])
  @@index([category])
  @@index([downloadCount])
  @@index([usageCount])
  @@index([createdAt])
}

model Sticker {
  id       BigInt @id @default(autoincrement())
  packId   BigInt
  emoji    String @db.VarChar(32) // –ê—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–º–æ–¥–∂–∏
  fileUrl  String @db.VarChar(512)
  fileName String @db.VarChar(128)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  width    Int
  height   Int
  fileSize Int
  mimeType String @db.VarChar(32)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: animated(1), premium(2)
  flags Int @default(0)

  usageCount Int @default(0)
  position   Int @default(0) // –ü–æ–∑–∏—Ü–∏—è –≤ –ø–∞–∫–µ

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  pack     StickerPack      @relation(fields: [packId], references: [id], onDelete: Cascade)
  messages MessageSticker[]

  @@index([packId])
  @@index([emoji])
  @@index([usageCount])
  @@index([position])
}

model CustomEmoji {
  id       BigInt  @id @default(autoincrement())
  chatId   BigInt? // –ï—Å–ª–∏ null - –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–º–æ–¥–∂–∏
  authorId BigInt
  name     String  @db.VarChar(32) // :custom_name:
  fileUrl  String  @db.VarChar(512)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  width    Int
  height   Int
  fileSize Int
  mimeType String @db.VarChar(32)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: animated(1), premium(2), verified(4), disabled(8)
  flags Int @default(0)

  usageCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  chat     Chat?          @relation("CustomEmojis", fields: [chatId], references: [id], onDelete: Cascade)
  author   User           @relation("CreatedEmojis", fields: [authorId], references: [id])
  messages MessageEmoji[]

  @@unique([chatId, name])
  @@index([chatId])
  @@index([authorId])
  @@index([name])
  @@index([flags])
  @@index([usageCount])
}

model GifCategory {
  id          BigInt  @id @default(autoincrement())
  name        String  @unique @db.VarChar(64)
  description String? @db.VarChar(255)
  iconUrl     String? @db.VarChar(512)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: trending(1), featured(2), nsfw(4)
  flags    Int @default(0)
  position Int @default(0)

  gifCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  gifs Gif[]

  @@index([name])
  @@index([flags])
  @@index([position])
}

model Gif {
  id         BigInt @id @default(autoincrement())
  categoryId BigInt
  title      String @db.VarChar(128)
  url        String @db.VarChar(512)
  previewUrl String @db.VarChar(512)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  width    Int
  height   Int
  fileSize Int
  duration Float? // –í —Å–µ–∫—É–Ω–¥–∞—Ö

  tags       String? @db.VarChar(255) // –¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
  searchText String? @db.VarChar(255) // –î–ª—è –ø–æ–∏—Å–∫–∞

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: trending(1), featured(2), nsfw(4), verified(8)
  flags Int @default(0)

  usageCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  category GifCategory  @relation(fields: [categoryId], references: [id])
  messages MessageGif[]

  @@index([categoryId])
  @@index([title])
  @@index([tags])
  @@index([flags])
  @@index([usageCount])
  @@index([searchText])
}

// –°–≤—è–∑–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –º–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
model MessageSticker {
  id        BigInt @id @default(autoincrement())
  messageId BigInt
  stickerId BigInt

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  sticker Sticker @relation(fields: [stickerId], references: [id])

  @@unique([messageId, stickerId])
  @@index([messageId])
  @@index([stickerId])
}

model MessageEmoji {
  id        BigInt @id @default(autoincrement())
  messageId BigInt
  emojiId   BigInt

  message Message     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  emoji   CustomEmoji @relation(fields: [emojiId], references: [id])

  @@unique([messageId, emojiId])
  @@index([messageId])
  @@index([emojiId])
}

model MessageGif {
  id        BigInt @id @default(autoincrement())
  messageId BigInt
  gifId     BigInt

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  gif     Gif     @relation(fields: [gifId], references: [id])

  @@unique([messageId, gifId])
  @@index([messageId])
  @@index([gifId])
}

// –ü–æ–∫—É–ø–∫–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å—Ç–∏–∫–µ—Ä-–ø–∞–∫–∏
model StickerPurchase {
  id       BigInt @id @default(autoincrement())
  userId   BigInt
  packId   BigInt
  price    Int // –¶–µ–Ω–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–æ–∫—É–ø–∫–∏
  currency String @default("USD") @db.VarChar(3)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack StickerPack @relation(fields: [packId], references: [id])

  @@unique([userId, packId])
  @@index([userId])
  @@index([packId])
  @@index([createdAt])
}

model UserStickerPack {
  id       BigInt @id @default(autoincrement())
  userId   BigInt
  packId   BigInt
  position Int    @default(0) // –ü–æ—Ä—è–¥–æ–∫ –≤ —Å–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: favorite(1), hidden(2)
  flags Int @default(0)

  addedAt DateTime @default(now()) @db.Timestamptz(3)

  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pack StickerPack @relation(fields: [packId], references: [id])

  @@unique([userId, packId])
  @@index([userId])
  @@index([packId])
  @@index([position])
  @@index([flags])
}

// ===== –ü–ê–ü–ö–ò –ß–ê–¢–û–í =====

model ChatFolder {
  id          BigInt  @id @default(autoincrement())
  userId      BigInt
  name        String  @db.VarChar(64)
  description String? @db.VarChar(255)
  color       String? @db.Char(7) // HEX —Ü–≤–µ—Ç
  iconUrl     String? @db.VarChar(512)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: pinned(1), collapsed(2), archived(4), default(8)
  flags    Int @default(0)
  position Int @default(0) // –ü–æ–∑–∏—Ü–∏—è –≤ —Å–ø–∏—Å–∫–µ –ø–∞–ø–æ–∫

  // –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤
  filters Json? // –£—Å–ª–æ–≤–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

  chatCount Int @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  user  User             @relation("UserFolders", fields: [userId], references: [id], onDelete: Cascade)
  chats ChatFolderItem[]

  @@index([userId])
  @@index([position])
  @@index([flags])
  @@index([userId, position])
}

model ChatFolderItem {
  id       BigInt @id @default(autoincrement())
  folderId BigInt
  chatId   BigInt
  position Int    @default(0) // –ü–æ–∑–∏—Ü–∏—è —á–∞—Ç–∞ –≤ –ø–∞–ø–∫–µ

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: pinned(1), muted(2), archived(4)
  flags Int @default(0)

  addedAt DateTime @default(now()) @db.Timestamptz(3)

  folder ChatFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  chat   Chat       @relation("FolderItems", fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([folderId, chatId])
  @@index([folderId])
  @@index([chatId])
  @@index([position])
  @@index([flags])
}

// ===== –ö–û–ù–¢–ï–ù–¢ (YOUTUBE + INSTAGRAM) =====

model Content {
  id           BigInt        @id @default(autoincrement())
  authorId     BigInt
  type         ContentType
  status       ContentStatus @default(DRAFT)
  title        String        @db.VarChar(200)
  description  String?       @db.Text
  thumbnailUrl String?       @db.VarChar(300)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: featured(1), monetized(2), ageRestricted(4), commentsDisabled(8)
  flags Int @default(0)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  metadata Json? // duration, resolution, codec –¥–ª—è –≤–∏–¥–µ–æ; dimensions –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

  // –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  viewsCount    BigInt @default(0)
  likesCount    BigInt @default(0)
  dislikesCount BigInt @default(0)
  sharesCount   BigInt @default(0)
  commentsCount Int    @default(0)

  // –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
  publishedAt DateTime? @db.Timestamptz(3)
  scheduledAt DateTime? @db.Timestamptz(3)

  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt DateTime? @db.Timestamptz(3)

  author      User                @relation(fields: [authorId], references: [id])
  attachments ContentAttachment[]
  comments    Comment[]
  likes       Like[]
  tags        ContentTag[]
  playlists   PlaylistItem[]
  history     WatchHistory[]
  reports     Report[]

  @@index([authorId])
  @@index([type])
  @@index([status])
  @@index([publishedAt])
  @@index([viewsCount])
  @@index([likesCount])
  @@index([createdAt])
  @@index([flags])
  @@index([type, status, publishedAt])
  @@index([authorId, type, status])
}

model ContentAttachment {
  id        BigInt   @id @default(autoincrement())
  contentId BigInt
  url       String   @db.VarChar(500)
  mimeType  String   @db.VarChar(64)
  fileSize  BigInt
  metadata  Json? // width, height, duration, bitrate, etc.
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([mimeType])
}

model Comment {
  id        BigInt  @id @default(autoincrement())
  contentId BigInt
  authorId  BigInt
  parentId  BigInt? // –î–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
  text      String  @db.VarChar(1000)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: deleted(1), edited(2), pinned(4), hearted(8)
  flags Int @default(0)

  likesCount BigInt    @default(0)
  createdAt  DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime  @updatedAt @db.Timestamptz(3)
  deletedAt  DateTime? @db.Timestamptz(3)

  content Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  author  User      @relation(fields: [authorId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")
  likes   Like[]

  @@index([contentId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
  @@index([likesCount])
  @@index([contentId, parentId, createdAt])
}

model Like {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  contentId BigInt?
  commentId BigInt?
  value     Int      @default(1) // 1 –¥–ª—è –ª–∞–π–∫–∞, -1 –¥–ª—è –¥–∏–∑–ª–∞–π–∫–∞
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@unique([userId, commentId])
  @@index([userId])
  @@index([contentId])
  @@index([commentId])
  @@index([createdAt])
}

model Tag {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(64)
  description String?  @db.VarChar(255)
  flags       Int      @default(0) // trending(1), official(2)
  usageCount  BigInt   @default(0)
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  contentTags ContentTag[]

  @@index([name])
  @@index([usageCount])
  @@index([flags])
}

model ContentTag {
  id        BigInt @id @default(autoincrement())
  contentId BigInt
  tagId     BigInt

  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contentId, tagId])
  @@index([contentId])
  @@index([tagId])
}

// Forum - main container for categories and posts
model Forum {
  id          BigInt          @id @default(autoincrement())
  name        String          @db.VarChar(128)
  slug        String          @unique @db.VarChar(64) // For SEO-friendly URLs
  description String?         @db.VarChar(500)
  createdAt   DateTime        @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime        @default(now()) @updatedAt @db.Timestamptz(3)
  ownerId     BigInt // References User (assumed to exist)
  categories  ForumCategory[] // One-to-many with categories
  posts       ForumPost[] // One-to-many with posts

  @@index([slug])
  @@index([ownerId])
}

// ForumCategory - single-level categories within a forum
model ForumCategory {
  id          BigInt      @id @default(autoincrement())
  forumId     BigInt // References Forum
  name        String      @db.VarChar(64)
  slug        String      @unique @db.VarChar(64) // For SEO-friendly URLs
  description String?     @db.VarChar(255)
  createdAt   DateTime    @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime    @default(now()) @updatedAt @db.Timestamptz(3)
  forum       Forum       @relation(fields: [forumId], references: [id], onDelete: Cascade)
  posts       ForumPost[] // One-to-many with posts

  @@index([forumId])
  @@index([slug])
}

// ForumPost - posts within a category
model ForumPost {
  id         BigInt         @id @default(autoincrement())
  forumId    BigInt // References Forum for quick access
  categoryId BigInt // References Category
  authorId   BigInt // References User (assumed to exist)
  title      String         @db.VarChar(200)
  content    String         @db.Text
  slug       String         @unique @db.VarChar(200) // For SEO-friendly URLs
  createdAt  DateTime       @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime       @default(now()) @updatedAt @db.Timestamptz(3)
  forum      Forum          @relation(fields: [forumId], references: [id], onDelete: Cascade)
  category   ForumCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  author     User           @relation(fields: [authorId], references: [id])
  replies    ForumReply[] // One-to-many with replies
  tags       ForumPostTag[] // Many-to-many with tags via ForumPostTag

  @@index([forumId])
  @@index([categoryId])
  @@index([authorId])
  @@index([slug])
  @@index([createdAt])
}

// ForumReply - comments/replies to posts
model ForumReply {
  id        BigInt    @id @default(autoincrement())
  postId    BigInt // References Post
  authorId  BigInt // References User (assumed to exist)
  content   String    @db.Text
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt DateTime  @default(now()) @updatedAt @db.Timestamptz(3)
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id])

  @@index([postId])
  @@index([authorId])
  @@index([createdAt])
}

// ForumTag - tags for categorizing posts
model ForumTag {
  id        BigInt         @id @default(autoincrement())
  name      String         @unique @db.VarChar(32)
  createdAt DateTime       @default(now()) @db.Timestamptz(3)
  posts     ForumPostTag[] // Many-to-many with posts via ForumPostTag

  @@index([name])
}

// ForumPostTag - junction table for post-tag relationship
model ForumPostTag {
  id     BigInt    @id @default(autoincrement())
  postId BigInt // References Post
  tagId  BigInt // References Tag
  post   ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    ForumTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// ===== –°–û–¶–ò–ê–õ–¨–ù–ê–Ø –°–ï–¢–¨ =====

model Subscription {
  id             BigInt @id @default(autoincrement())
  subscriberId   BigInt
  subscribedToId BigInt

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: notificationsEnabled(1), premium(2)
  flags     Int      @default(1)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  subscriber   User @relation("UserSubscriptions", fields: [subscriberId], references: [id], onDelete: Cascade)
  subscribedTo User @relation("SubscribedTo", fields: [subscribedToId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, subscribedToId])
  @@index([subscriberId])
  @@index([subscribedToId])
  @@index([createdAt])
}

model Playlist {
  id           BigInt  @id @default(autoincrement())
  authorId     BigInt
  title        String  @db.VarChar(128)
  description  String? @db.VarChar(500)
  thumbnailUrl String? @db.VarChar(300)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: public(1), collaborative(2), featured(4)
  flags Int @default(1)

  itemsCount Int      @default(0)
  createdAt  DateTime @default(now()) @db.Timestamptz(3)
  updatedAt  DateTime @updatedAt @db.Timestamptz(3)

  author User           @relation(fields: [authorId], references: [id])
  items  PlaylistItem[]

  @@index([authorId])
  @@index([flags])
  @@index([createdAt])
}

model PlaylistItem {
  id         BigInt   @id @default(autoincrement())
  playlistId BigInt
  contentId  BigInt
  position   Int
  addedAt    DateTime @default(now()) @db.Timestamptz(3)

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  content  Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([playlistId, contentId])
  @@index([playlistId, position])
  @@index([contentId])
}

model WatchHistory {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  contentId BigInt
  watchedAt DateTime @default(now()) @db.Timestamptz(3)
  watchTime Int      @default(0) // –°–µ–∫—É–Ω–¥—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  completed Boolean  @default(false)
  progress  Float    @default(0) // –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (0-1)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@index([userId])
  @@index([contentId])
  @@index([watchedAt])
  @@index([userId, watchedAt])
}

model Notification {
  id      BigInt           @id @default(autoincrement())
  userId  BigInt
  type    NotificationType
  title   String           @db.VarChar(128)
  message String           @db.VarChar(255)
  data    Json? // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (ID –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç.–¥.)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: read(1), important(2)
  flags Int @default(0)

  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  readAt    DateTime? @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([flags])
  @@index([createdAt])
  @@index([userId, flags, createdAt])
}

// ===== –ú–û–î–ï–†–ê–¶–ò–Ø –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ =====

model Report {
  id          BigInt       @id @default(autoincrement())
  reporterId  BigInt
  userId      BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  contentId   BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
  postId      BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ –ø–æ—Å—Ç —Ñ–æ—Ä—É–º–∞
  replyId     BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ –æ—Ç–≤–µ—Ç —Ñ–æ—Ä—É–º–∞
  messageId   BigInt? // –ï—Å–ª–∏ –∂–∞–ª—É–µ–º—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
  reason      ReportReason
  status      ReportStatus @default(PENDING)
  description String?      @db.VarChar(500)

  // –ë–∏—Ç–æ–≤—ã–µ —Ñ–ª–∞–≥–∏: reviewed(1), resolved(2), dismissed(4), escalated(8)
  flags Int @default(0)

  // –ú–æ–¥–µ—Ä–∞—Ü–∏—è
  reviewedBy BigInt?
  reviewedAt DateTime?        @db.Timestamptz(3)
  resolution String?          @db.VarChar(500)
  action     ModerationAction @default(NONE)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  reporter User     @relation("ReportedBy", fields: [reporterId], references: [id])
  user     User?    @relation("ReportedUser", fields: [userId], references: [id])
  content  Content? @relation(fields: [contentId], references: [id])
  reviewer User?    @relation("ReviewedReports", fields: [reviewedBy], references: [id])

  @@index([reporterId])
  @@index([userId])
  @@index([contentId])
  @@index([postId])
  @@index([replyId])
  @@index([messageId])
  @@index([reason])
  @@index([status])
  @@index([flags])
  @@index([createdAt])
  @@index([reviewedBy])
  @@index([status, createdAt]) // –î–ª—è –æ—á–µ—Ä–µ–¥–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
}

// ===== –ù–ê–°–¢–†–û–ô–ö–ò –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====

model RefreshToken {
  id        BigInt   @id @default(autoincrement())
  sessionId BigInt   @unique // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Å—Å–∏—é
  userId    BigInt // ‚úÖ –£–±—Ä–∞–ª–∏ @unique - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ç–æ–∫–µ–Ω—ã —Å —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  token     String   @unique @db.VarChar(255)
  tokenHash String   @unique @db.VarChar(255) // –•–µ—à —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  expiresAt DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)
  deviceId  String?  @unique // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Ç–æ–∫–µ–Ω –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  ipAddress String?  @db.Inet
  userAgent String?  @db.VarChar(512)
  isRevoked Boolean  @default(false)
  isUsed    Boolean  @default(false) // For reuse detection (Signal/Stripe pattern)

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
  @@index([isRevoked])
  @@index([isUsed])
  @@index([userId, isRevoked])
  @@index([userId, isUsed])
}

model RefreshTokenBlacklist {
  id        BigInt   @id @default(autoincrement())
  tokenHash String   @unique @db.VarChar(64)
  userId    BigInt
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  expiresAt DateTime @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
}

model ContactList {
  id          BigInt   @id @default(autoincrement())
  userId      BigInt
  contactId   BigInt
  displayName String?  @db.VarChar(64)
  phoneNumber String?  @db.VarChar(15)
  addedAt     DateTime @default(now()) @db.Timestamptz(3)
  flags       Int      @default(0) // blocked(1), favorite(2)

  user    User @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
  contact User @relation("ContactOf", fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([userId, contactId])
  @@index([userId])
  @@index([contactId])
  @@index([flags])
}

model UserSettings {
  id     BigInt @id @default(autoincrement())
  userId BigInt @unique

  // –û–±—ä–µ–¥–∏–Ω–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ JSON –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –∫–æ–ª–æ–Ω–æ–∫
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { theme: string, language: string, fontSize: number, animations: boolean }
  uiSettings    Json? // theme, language, fontSize, animations
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { enabled: boolean, sound: boolean, vibration: boolean, types: string[] }
  notifications Json? // enabled, sound, vibration, types
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { lastSeen: string, profilePhoto: string, status: string, messaging: string }
  privacy       Json? // lastSeen, profilePhoto, status, messaging
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { biometric: boolean, twoFactor: boolean, sessionTimeout: number }
  security      Json? // biometric, twoFactor, sessionTimeout
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { autoDownload: string, backup: boolean, quality: string }
  dataStorage   Json? // autoDownload, backup, quality settings
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { autoplay: boolean, captions: boolean, recommendations: boolean }
  content       Json? // autoplay, captions, recommendations
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: { betaFeatures: string[], labs: boolean }
  experimental  Json? // beta features, labs
  blockedUsers  BigInt[] // –ú–∞—Å—Å–∏–≤ ID –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChatSettings {
  id       BigInt @id @default(autoincrement())
  chatId   BigInt @unique
  settings Json? // slowMode, maxMembers, joinApproval, autoDelete, etc.

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(3)

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
}

model NotificationSettings {
  id               BigInt   @id @default(autoincrement())
  userId           BigInt
  chatId           BigInt?
  notificationType String   @db.VarChar(32)
  flags            Int      @default(7) // enabled(1), sound(2), vibration(4)
  createdAt        DateTime @default(now()) @db.Timestamptz(3)
  updatedAt        DateTime @updatedAt @db.Timestamptz(3)

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  chat Chat? @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId, notificationType])
  @@index([userId])
  @@index([chatId])
  @@index([notificationType])
}

// ===== –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê =====

model ChatStatsCache {
  chatId           BigInt    @id
  messageCount     Int       @default(0)
  participantCount Int       @default(0)
  lastActivity     DateTime? @db.Timestamptz(3)
  storageBytes     BigInt    @default(0)
  lastUpdated      DateTime  @default(now()) @db.Timestamptz(3)

  @@index([lastActivity])
  @@index([lastUpdated])
}

model UserStatsCache {
  userId        BigInt    @id
  messagesSent  Int       @default(0)
  chatsCount    Int       @default(0)
  contactsCount Int       @default(0)
  storageUsed   BigInt    @default(0)
  lastActivity  DateTime? @db.Timestamptz(3)
  lastUpdated   DateTime  @default(now()) @db.Timestamptz(3)

  @@index([lastActivity])
  @@index([lastUpdated])
}

model ContentStatsCache {
  contentId    BigInt   @id
  hourlyViews  Json? // –ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
  dailyViews   Json? // –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  demographics Json? // –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏
  engagement   Json? // –ú–µ—Ç—Ä–∏–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏
  revenue      Json? // –î–∞–Ω–Ω—ã–µ –æ –¥–æ—Ö–æ–¥–∞—Ö
  lastUpdated  DateTime @default(now()) @db.Timestamptz(3)

  @@index([lastUpdated])
}

// ===== –ê–†–•–ò–í–ò–†–û–í–ê–ù–ò–ï =====

model MessageArchive {
  id              BigInt      @id @default(autoincrement())
  originalId      BigInt
  chatId          BigInt
  senderId        BigInt
  content         Bytes
  messageType     MessageType
  createdAt       DateTime    @db.Timestamptz(3)
  archiveDate     DateTime    @default(now()) @db.Timestamptz(3)
  compressionType String      @default("gzip") @db.VarChar(16)

  @@index([chatId, createdAt])
  @@index([originalId])
  @@index([archiveDate])
}

model ContentArchive {
  id              BigInt      @id @default(autoincrement())
  originalId      BigInt
  authorId        BigInt
  type            ContentType
  metadata        Json // –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  archiveDate     DateTime    @default(now()) @db.Timestamptz(3)
  archiveReason   String      @db.VarChar(64) // deleted, expired, compliance
  compressionType String      @default("gzip") @db.VarChar(16)

  @@index([originalId])
  @@index([authorId])
  @@index([type])
  @@index([archiveDate])
}

// ===== –ü–û–ò–°–ö–û–í–´–ô –ö–≠–®–ò =====

model SearchCache {
  queryHash String   @id @db.VarChar(32)
  results   Json
  expiresAt DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  hitCount  Int      @default(1)

  @@index([expiresAt])
  @@index([hitCount])
  @@index([createdAt])
}

model TrendingCache {
  id        BigInt   @id @default(autoincrement())
  type      String   @db.VarChar(32) // tags, creators, content
  data      Json // –¢—Ä–µ–Ω–¥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  region    String?  @db.VarChar(8) // –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ä–µ–≥–∏–æ–Ω
  expiresAt DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  @@index([type])
  @@index([region])
  @@index([expiresAt])
}
